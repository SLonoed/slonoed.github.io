{"data":{"site":{"siteMetadata":{"title":"slonoed","author":"Dmitry Manannikov","siteUrl":"https://slonoed.net"}},"markdownRemark":{"id":"6e27d4bd-7f15-54b9-9d97-e6ceb6bc7082","html":"<p>Я уже писал про <a href=\"https://slonoed.net/ru/code-review/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">процесс код ревью</a>. Теперь хочу осветить одну важную связанную с этим тему. Если быть точнее, инструментарий, а именно пользовательские правила <strong>eslint</strong>.</p>\n<p>Eslint — мощный инструмент, предоставляющий огромное число проверок кода и даже автоматическое исправление ошибок. А экосистема плагинов позволяет расширить набор до практически любых требований.</p>\n<p>Однако бывает необходимость добавить проверки, которых нет в готовых плагинах. Часто это стилевые договоренности в команде или особенности внутреннего кода.</p>\n<p>В этом руководстве я покажу:</p>\n<ol>\n<li>как настроить eslint, чтобы добавление правил было таким же простым, как и написание другого кода в проекте</li>\n<li>как создать пользовательское правило</li>\n</ol>\n<p><em>Я исхожу из того, что в проекте уже есть eslint и не буду рассказывать, как его настроить.</em></p>\n<h2 id=\"создание-пользовательского-правила\"><a href=\"#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0\" aria-label=\"создание пользовательского правила permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Создание пользовательского правила</h2>\n<p>Давайте разберем создание нового правила на примере запрета использования ключевого слова <code class=\"language-text\">await</code> в сложных выражениях. Такое правило не будет показывать ошибку в следующих случаях:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Декларирование переменной</span>\n<span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> b\n<span class=\"token comment\">// Присваивание переменной</span>\na <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> b\n<span class=\"token comment\">// Возврат значения из функции</span>\n<span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> b\n<span class=\"token comment\">// Выражение</span>\n<span class=\"token keyword\">await</span> b</code></pre></div>\n<p>Все остальные случаи использования будут генерировать ошибку:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">await</span> b\na <span class=\"token operator\">=</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> b<span class=\"token punctuation\">)</span>\na <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  x<span class=\"token punctuation\">:</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  z<span class=\"token punctuation\">:</span> <span class=\"token keyword\">await</span> b\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>Я использую это правило в своих проектах, потому как вижу пользу от явного обозначения асинхронной операции. К тому же код, который компилируется для старых браузеров проще отлаживать. Однако, я вижу, что не всем это правило кажется обоснованным. Я не хочу аргументировать полезность использования этого правила в работе, а просто использую его для примера.</em></p>\n<h2 id=\"немного-теории\"><a href=\"#%D0%BD%D0%B5%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE-%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D0%B8\" aria-label=\"немного теории permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Немного теории</h2>\n<p>Большинство компиляторов при компиляции языка используют построение абстрактного синтаксического дерева (<strong>a</strong>bstract <strong>s</strong>yntax <strong>t</strong>ree, <strong>AST</strong>). AST представляет собой иерархический набор данных, описывающий программу.\nДля визуального представления AST очень удобно использовать сервис <a href=\"https://astexplorer.net/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">astexplorer.net</a>.\nОн предоставляет широкий выбор языков и парсеров. Интерфейс выглядит довольно просто. В верхней части можно выбрать язык и парсер, слева вводить исходный код, а справа будет показываться AST.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57f3aab712335d5a4094457f2bbb3cce/d15a1/ast_show.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.87090558766859%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVUlEQVQoz52QXUvDMBiF9/9/wC68EPXKG/ETvVWvnDhEpjK7Nm36lTZtk3TtQG92fNvabWyCYODhBN7mOU0GruuCc444jhFFESzLwuNoRDyAMQe+70OmCc3Cdh5ThmEH9zkcm8F1OAIe0kxggK2Vpilu7+7xPLFgzRgdmMFiMZjLwT0Ptido78O2bdiOjdmU4eXpDR/vDgIvwmC5XKKnWYt6gSD0qY3BEwJJIpDKlIoEpGz2SVsqpUSWZciLnFK2aUqzK6zrLyg5hor24McnsKJLlPoMdXmO2lxQnqI0DNpU0FoRmjBtKqW6K28LtRqjlENoMaT2fYjsEJU+IiGhD2D0lA5XRNFKehrpL8JPqPwVOj2GyS9JdIO5vl5R6SsSMhLMN/5wza5wsUAiOJJg0r0XvVXfrtSaRtblX8K6Rp7nK0GxcZ1/C4ui+PlArbKTruml28JvoK+iau5RHecAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"astexplorer window\"\n        title=\"\"\n        src=\"/static/57f3aab712335d5a4094457f2bbb3cce/623ee/ast_show.png\"\n        srcset=\"/static/57f3aab712335d5a4094457f2bbb3cce/816c5/ast_show.png 148w,\n/static/57f3aab712335d5a4094457f2bbb3cce/c766b/ast_show.png 295w,\n/static/57f3aab712335d5a4094457f2bbb3cce/623ee/ast_show.png 590w,\n/static/57f3aab712335d5a4094457f2bbb3cce/e5345/ast_show.png 885w,\n/static/57f3aab712335d5a4094457f2bbb3cce/7a439/ast_show.png 1180w,\n/static/57f3aab712335d5a4094457f2bbb3cce/84fe0/ast_show.png 1770w,\n/static/57f3aab712335d5a4094457f2bbb3cce/d15a1/ast_show.png 2076w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p><em>В этом тексте я буду использовать JavaScript и Babel, но полученный опыт можно легко перенести на любой другой язык.</em></p>\n<p>Давайте разберём простейший пример объявления функции.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> arg\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c35192637818fd9ea07e2686f3a4f423/ab62a/ast_file.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 122.04030226700253%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAABYlAAAWJQFJUiTwAAACsklEQVQ4y5VUyW7bMBT0r/fQc0/JrWhz7K099NIUAYKiS9IkXmRLsiTbWqyFsrhIdookdTx9lOMs7mYRGJBPy3CG7z22lsslbq5vcLtcYXl7i81Y/PiJjhXAGpiwnQiu7WI8tGAOxxg4ATzXgesMMfSCOnZo7XkeWtgaq9Wqnm+ur8Azhsz4Bj7pIxq74P4E5eISVaVQllWNqlTruNJxiZYm2IYeV1dEyAUK6wTs81tMzk/RPz1DYptQnIMLAfEHtB6T/EYoJcQsRz74hNw5QeT2MHIsxPRMKgUhN5CQmpDmv1reKJTFDGk6RpymYIzWeUExg8hzqJnG7J5Mz/8h5JBSYEZEfvc7vF4bhmGhbwzgWgP4roXpoAuZJRBa8W6EsranJhaS9leMegbGRg+R0UZK4PG0dtFIof5YFAWYcYzY7VOJ2IhHDoqJB0nZbXCGdwoJxSxDkcfgNDN9bvRO6Y2IqPEZSspkno6QBG2w2IWTJAgZuyfckMndFOoPSyL0wKYmApYg5QUKTaaelozc2bIgy1mIwB8iDBPkSQrFMkiWQlLpNFR4d06kJvEc+BfH8Mw+XNNAaPfBqSXlXck0UEiWVEnlwSAjmxRGhClUltad1FhhbTlPMaOfUjkHEyUygqDLQdKFsFG3G2FttwSPKCnnR/B7HdidNiyC37tAQbYfLDcobEmFnVlfEVEx+2EMP4gQBgFkmkCV1fqSEE2SQsS8vKTe7SBsf4Hb7WJCrReZbUyNMwjfIaV8904RgtZqDhUeoTh/htzYg9k5QPfiNQLjJRbZG8zVuwYKiVBQQip5gtJ5DuG+oH7eJ2X7qPw9XPJXWKiDZpaFzizvoxTvaYMPtMFHzMs1KnVImx02sSzqWB+8bsU1dCKeYmeFRU22UfqAda8/4J+Em5+KLaXbJI/xC7pPHgUqbLsdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"astexplorer File tree\"\n        title=\"\"\n        src=\"/static/c35192637818fd9ea07e2686f3a4f423/623ee/ast_file.png\"\n        srcset=\"/static/c35192637818fd9ea07e2686f3a4f423/816c5/ast_file.png 148w,\n/static/c35192637818fd9ea07e2686f3a4f423/c766b/ast_file.png 295w,\n/static/c35192637818fd9ea07e2686f3a4f423/623ee/ast_file.png 590w,\n/static/c35192637818fd9ea07e2686f3a4f423/e5345/ast_file.png 885w,\n/static/c35192637818fd9ea07e2686f3a4f423/7a439/ast_file.png 1180w,\n/static/c35192637818fd9ea07e2686f3a4f423/ab62a/ast_file.png 1588w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>У каждого элемента дерева есть поле <code class=\"language-text\">type</code>, показывающее тип узла, а также дополнительные поля: свойства элемента или его потомки. Например, у объявления функции (<code class=\"language-text\">FunctionDeclaration</code>) есть свойство <code class=\"language-text\">async: false</code>, указывающее что это не асинхронная функция.</p>\n<p>Если представить поддерево функции в виде схемы, то получится такая картина:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6134529e8d2747a2b37141417686e90f/e7b01/tree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACCklEQVQ4y4VTa3PiMAzM//9FbRmux6NwX4BO6dxAuQtQQgJNCI/EztPZSr6GSXOUZkYYW/KutJKNLMuQpil4Lf/neY7j8YjFfI65aeLPbHZe9/s94jg+x9bvGuVB6dSASmG32+Gh1cJ9o4Feu41epwN3s9FgVcA6sFEFKq0oFHzfQ6fbQa/Xx2g0wspagb80zRBF0X9JlGZUHXnOxnsFy/Ixna4gREDlC5Qf++M4glKZJuZPUUWfMmTNlCpwOmV420Y4HBjQw/2Pn5hMTOx9CX+X4rBXcN8iIogQBCm2W5fiVlSNr2UQQsDgn/H4Ce32A11ekyOFlILYEmKNEZwUXc6JNEEYSiIVRJjAc1N0u79we3uDwWCgZQiC4B/gjLr38jKFbVs6dSnZGcJxHDIbz2MLzmZLl+QHWaoJuHQukzHCMNRZGkmSaHTe8MoO1sSxbTSJvd/pY0IVLM2/Wi+OZ4Asy8/jwpKxaQ3Lw7pJIak0n/SLIEKGKnTmDMagX3b50iGzsdCWZWnRH0cmFosl6XfSFdQBvx3soijwulyi1Wzq4f79NMYrvZT8I05KqUm/HOw6IO+5Y67r4ng4wPMyyio7a3z1pdTf8uc9CU3d3HkxjUlMoPIi2LclVxmHwyHu7ho0q8+6TM6wDna15Hogz+J6vaYZtXWHWb+rgJfSrgZyR0tjDasdvnT3HXsYzloHNFLuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"tree\"\n        title=\"\"\n        src=\"/static/6134529e8d2747a2b37141417686e90f/623ee/tree.png\"\n        srcset=\"/static/6134529e8d2747a2b37141417686e90f/816c5/tree.png 148w,\n/static/6134529e8d2747a2b37141417686e90f/c766b/tree.png 295w,\n/static/6134529e8d2747a2b37141417686e90f/623ee/tree.png 590w,\n/static/6134529e8d2747a2b37141417686e90f/e5345/tree.png 885w,\n/static/6134529e8d2747a2b37141417686e90f/7a439/tree.png 1180w,\n/static/6134529e8d2747a2b37141417686e90f/84fe0/tree.png 1770w,\n/static/6134529e8d2747a2b37141417686e90f/e7b01/tree.png 1776w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>Зачем вообще нужно это дерево? Дело в том, что программно намного проще манипулировать логическими объектами, а не обрабатывать строки. Сам процесс построения дерева может быть сложным и требующим хорошего понимания спецификации языка. К счастью, eslint предоставляет API работающий на уровне уже готового дерева. И в следующей секции я покажу, как это API использовать.</p>\n<h2 id=\"настройка-eslint\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-eslint\" aria-label=\"настройка eslint permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка eslint</h2>\n<p>Я предполагаю, что в вашем проекте уже настроен eslint, если нет, то используйте <a href=\"https://eslint.org/docs/user-guide/getting-started\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">официальную документацию</a>.</p>\n<p>Дополнительно нам нужно установить <a href=\"https://github.com/cletusw/eslint-plugin-local-rules\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">плагин для работы с локальными правилами</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> eslint-plugin-local-rules --save-dev</code></pre></div>\n<p>После чего нужно добавить в конфигурацию eslint подключение этого плагина, а также включить наше кастомное правило.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ... другие настройки</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'eslint-plugin-local-rules'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* другие плагины */</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  rules<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ... другие правила</span>\n    <span class=\"token string\">'local-rules/no-bad-await'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'error'</span> <span class=\"token comment\">// Наше будущее правило</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>В примере используется JS файл конфигурации, но легко адаптировать под JSON или YAML.</em></p>\n<h2 id=\"создание-правила\"><a href=\"#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0\" aria-label=\"создание правила permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Создание правила</h2>\n<p>Для начала создайте файл <code class=\"language-text\">eslint-local-rules.js</code> в корне проекта. И добавьте в него следующий код</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"no-bad-await\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    create<span class=\"token punctuation\">:</span> context <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> allowedAncestors <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"ReturnStatement\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"VariableDeclarator\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"ExpressionStatement\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"AssignmentExpression\"</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        AwaitExpression<span class=\"token punctuation\">:</span> node <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> ancestors <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getAncestors</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> ancestors<span class=\"token punctuation\">[</span>ancestors<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowedAncestors<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            context<span class=\"token punctuation\">.</span><span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              node<span class=\"token punctuation\">,</span>\n              message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Не используйте await в выражениях.\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Данный файл должен экспортировать объект. Ключ в таком объекте является именем правила (в нашем случае <code class=\"language-text\">no-bad-await</code>), а значение - самим правилом. Простейшее правило можно описать объектом с одним методом: <code class=\"language-text\">create</code>. Этот метод получает первым аргументом объект <code class=\"language-text\">context</code>, содержащий различную информацию о настройках и полезные утилиты для работы с AST. Вернуть он должен объект, реализующий паттерн “посетитель” (visitor).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  AwaitExpression<span class=\"token punctuation\">:</span> node <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> ancestors <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getAncestors</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> ancestors<span class=\"token punctuation\">[</span>ancestors<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowedAncestors<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        node<span class=\"token punctuation\">,</span>\n        message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Не используйте await в выражениях.\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Ключ в таком объекте является типом узла дерева, а значение — функцией, которая будет вызвана при посещении узла. При запуске eslint строит дерево, идёт по узлам, начиная с корня, и вызывает соответствующие функции, передавая в них текущий узел.</p>\n<p>В нашем случае функция будет вызываться на каждое найденое выражение <code class=\"language-text\">await</code>.</p>\n<p>Давайте разберем код функции-посетителя детально. Для начала нам нужно получить родительский узел, чтобы понять, является ли он запрещенным. Для этого мы используем API контекста <code class=\"language-text\">getAncestors</code>, возвращающий массив всех предков и берем последний из массива.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ancestors <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getAncestors</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> ancestors<span class=\"token punctuation\">[</span>ancestors<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>После чего мы проверяем, что родитель узла имеет один из разрешенных типов.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowedAncestors<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    node<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Не используйте await в выражениях.\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Например, в коде</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> b\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>родителем у <code class=\"language-text\">AwaitExpression</code> является <code class=\"language-text\">ExpressionStatement</code></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75bd282eddade469fea305ff50721bc7/d042d/exp_st.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.570281124497996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABbUlEQVQoz5WQu27bMABF/f9L0b1ppwDN1DFrilpDkCVGbPkRS45I6mmLD8koUA8+JeUI8NaUwIVI4vLwUBOddxz1b/ruD6fTifP5TBizxYbvd3f8ih6Zx2u22w1vsiTLBFIKdpkkXies4w2zpyW7V0myypiMgHGM66Z1LJerAZamO4qiIBUVmSxQSpEXJULVfj/Mc/b7Btc5JiNkjF8NwOOxx1pD5zp0oyjUiqQ6EOc1Sd1wMJrOA6zzsRZjDFrri+FodT3v+562bX3JYHRLIbeD6S5TbFKBkhJdKp8cHXom9PTF8Pq518BwYygNtx805WxK9jJlOX/m+WXhM+c1XmDqEmPfDf8JfH/K8N1X7PMEUdVkZYUoa6om2DnfueRDwGAZDplW0OQ/UOU9oo7ImynW/KQzD0Ocif4DqMPPTzHFJ2/5mbfqG0V9Q6dvONqvPl98bj8INAFofXKcjrzJlN5GHhB5s2gwC3vOPPIXuWmlTiuIA0QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"ExpressionStatement as a parent\"\n        title=\"\"\n        src=\"/static/75bd282eddade469fea305ff50721bc7/623ee/exp_st.png\"\n        srcset=\"/static/75bd282eddade469fea305ff50721bc7/816c5/exp_st.png 148w,\n/static/75bd282eddade469fea305ff50721bc7/c766b/exp_st.png 295w,\n/static/75bd282eddade469fea305ff50721bc7/623ee/exp_st.png 590w,\n/static/75bd282eddade469fea305ff50721bc7/e5345/exp_st.png 885w,\n/static/75bd282eddade469fea305ff50721bc7/7a439/exp_st.png 1180w,\n/static/75bd282eddade469fea305ff50721bc7/84fe0/exp_st.png 1770w,\n/static/75bd282eddade469fea305ff50721bc7/d042d/exp_st.png 1992w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>А в коде</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">await</span> b\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Родителем является <code class=\"language-text\">BinaryExpression</code></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36eed20d3287eb046a4848492ce73789/afc75/bin_exp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.83905789990187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABl0lEQVQoz5WSUW/TMBSF+/d55AEhwVbBljbrWPkVPICmqWOwtAttl4YscdIktpNMMNT2w0kXVN7aKx3dK1n+dM61O5V+REUaHZUU+onfT39Yr9fU9enzFcPhkC9XNzjOD7xFhOcL/EVg5hDH9Zk4c64vXWZ3IYu5oLNardhsNo3aascoTplOZ0xclyi4xAu+MvW/4f0cEUUjhLghiUcskxEy/05RjOmwU7vg2mVRaJQuKbVAxV1i0WUhbHzRI88sfmmLR9WjqiUtSnlKp4XsqoUrpcgyiZQRRWoThic8JOd48QWB6Zm0keqMUtkGZjf9P4ctqO1aK/JcmTghlf6Ijt+xvH1BMHnF3biLc9vlfnxEsbTMeQ3t7wk0Dkt1QZmdkk9fEs/fcj97TzA3a5gdI4WFymwT/RCg/GAu2GTimNQ4TfNzlByYnzHYxjXuqr0j7wB1fIQI3jAOBrhB/UB9imfYYZEbYN9Es0gfXhOJE0LzMElyhkz7jQ7foexR5NtdVbJ2Zv+L22pvYJFvgU2052/SgNU2bqu/Uegu7PRGu+UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"BinaryExpression as a parent\"\n        title=\"\"\n        src=\"/static/36eed20d3287eb046a4848492ce73789/623ee/bin_exp.png\"\n        srcset=\"/static/36eed20d3287eb046a4848492ce73789/816c5/bin_exp.png 148w,\n/static/36eed20d3287eb046a4848492ce73789/c766b/bin_exp.png 295w,\n/static/36eed20d3287eb046a4848492ce73789/623ee/bin_exp.png 590w,\n/static/36eed20d3287eb046a4848492ce73789/e5345/bin_exp.png 885w,\n/static/36eed20d3287eb046a4848492ce73789/7a439/bin_exp.png 1180w,\n/static/36eed20d3287eb046a4848492ce73789/84fe0/bin_exp.png 1770w,\n/static/36eed20d3287eb046a4848492ce73789/afc75/bin_exp.png 2038w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>И если родитель имеет тип, отличный от разрешенных, то выводим ошибку, вызвав метод <code class=\"language-text\">context.report</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">context<span class=\"token punctuation\">.</span><span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">,</span>\n  message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Не используйте await в выражениях.\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Заметьте, что одним из параметром является <code class=\"language-text\">node</code>. Это параметр нужен, чтобы указать eslint (и редакторам его использующим), какой участок показать как ошибочный. Это не обязательно должен быть узел, переданный в “посетителя”, может быть его родитель или любой другой.</p>\n<p>Естественно, внутренний API для правил намного богаче и позволяет эффективно делать любые проверки кода. Ознакомиться детальнее можно в <a href=\"https://eslint.org/docs/developer-guide/working-with-rules#rule-basics\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">документации</a>. Но самое важное, что небольшие правила можно написать <strong>быстро и легко</strong>.</p>\n<h2 id=\"организационные-вопрос\"><a href=\"#%D0%BE%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5-%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81\" aria-label=\"организационные вопрос permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Организационные вопрос</h2>\n<p><strong>Когда должны выполняться проверки?</strong></p>\n<p>Проверки <strong>обязательно</strong> должны выполняться автоматически при создании Pull Request, до того как код попадет на ревью к человеку.</p>\n<p><em>Существует практика делать проверки, используя прекоммит хук. Я считаю её неправильной в виду того, что она сильно раздражает, задерживая коммит. При этом не освобождает от необходимости запуска проверок на сервере.</em></p>\n<p><strong>Когда вносить правило?</strong></p>\n<p>После того, как на ревью появилась дискуссия с разными мнениями и решение было найдено. Даже если все текущие участники договорились про стиль, придет новый человек и обязательно повторит тоже самое.</p>\n<p><strong>Как вносить правило, если в коде уже есть проблемы?</strong></p>\n<p>Если проблем немного и их легко поправить разом, то лучше так и сделать. Если их много и они требуют времени, то хорошим вариантом будет использовать режим предупреждения (warning, показать пример настройки). Тогда люди, которые пишут новый код, будут видеть предупреждения. Старый код будет уходить со временем и планомерным рефакторингом. Можно использовать аргумент <code class=\"language-text\">--max-warnings</code>, который позволяет зафиксировать максимальное количество предупреждений.</p>","timeToRead":7,"frontmatter":{"title":"Пользовательские правила eslint","date":"May 19, 2019","description":"Пример написания своего правила для eslint"},"fields":{"slug":"/ru/custom-eslint-rule/","langKey":"ru"}},"altPost":null},"pageContext":{"slug":"/ru/custom-eslint-rule/","altSlug":"/custom-eslint-rule/"}}