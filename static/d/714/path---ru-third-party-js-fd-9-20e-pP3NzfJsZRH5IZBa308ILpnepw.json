{"data":{"site":{"siteMetadata":{"title":"slonoed","author":"Dmitry Manannikov","siteUrl":"https://slonoed.net"}},"markdownRemark":{"id":"eb269d42-7a93-5667-98e4-e3c396cc1f7b","html":"<p>Довольно много продуктов используют сторонние (third party) библиотеки.\nХорошим примером являются скрипты Google Analytics, Яндекс Метрики.\nТакие библиотеки грузятся с отдельного домена и предоставляют API к конечному продукту.\nЯ занимался поддержкой и улучшением подобной библиотеки в компании flocktory.\nРасскажу об особенностях разработки такой библиотеки и освещу хорошие практики и расскажу как обойти основные ошибки.\nДоклад структурирован снизу вверх. Поэтому сначала я затрону вопросы написания кода, а к концу расскажу про общие вещи.</p>\n<h2 id=\"принципы\"><a href=\"#%D0%BF%D1%80%D0%B8%D0%BD%D1%86%D0%B8%D0%BF%D1%8B\" aria-label=\"принципы permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Принципы</h2>\n<p>Для структурирования и применения информации удобно условиться о принципах разработки подобных продуктов. Предлагаю четыре основных принципа в порядке убывания важности.</p>\n<ol>\n<li>Не навреди (Безопасность)</li>\n<li>Работай правильно (Корректность)</li>\n<li>Тайминг важен (Оптимизация времени)</li>\n<li>Производительность важна</li>\n</ol>\n<p><em>На самом деле пункты 3 и 4 могут меняться местами. Всё зависит от назначения продукта и сайтов, где он используется.</em></p>\n<p>Рассмотрим каждый из них в отдельности.</p>\n<h3 id=\"не-навреди\"><a href=\"#%D0%BD%D0%B5-%D0%BD%D0%B0%D0%B2%D1%80%D0%B5%D0%B4%D0%B8\" aria-label=\"не навреди permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Не навреди</h3>\n<p>Код библиотеки исполняется на стороннем сайте. Новые клиенты появляются каждый день. Поломка кода любого из сайтов может привести к огромным репутационным и денежным потерям.</p>\n<h3 id=\"работай-правильно\"><a href=\"#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B9-%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE\" aria-label=\"работай правильно permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Работай правильно</h3>\n<p>Для бизнеса очень важно, чтобы этот код работал правильно. Согласитесь, никто не станет использовать гугл анатлитику, если аналитика там будет показывать неправильные данные.</p>\n<h3 id=\"тайминг-важен\"><a href=\"#%D1%82%D0%B0%D0%B9%D0%BC%D0%B8%D0%BD%D0%B3-%D0%B2%D0%B0%D0%B6%D0%B5%D0%BD\" aria-label=\"тайминг важен permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Тайминг важен</h3>\n<p>Для подобных библиотек важна скорость загрузки и старта. Ранний старт позволяет не пропустить первые действия пользователя.</p>\n<h3 id=\"производительность-важна\"><a href=\"#%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D0%B2%D0%B0%D0%B6%D0%BD%D0%B0\" aria-label=\"производительность важна permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Производительность важна</h3>\n<p>Никто не будет терпеть на сайте код, который тормозит и ухудшает пользовательский опыт.</p>\n<h2 id=\"глобальный-объект\"><a href=\"#%D0%B3%D0%BB%D0%BE%D0%B1%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82\" aria-label=\"глобальный объект permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Глобальный объект</h2>\n<p>В самом идеальном варианте ваш код должен быть завёрнут в замыкание без какого либо способа быть вызванным снаружи. В случае, если вам нужно дать некий API, то лучшее, что вы можете себе позволить – это один глобальный объект, который не вызовет коллизий, например <code class=\"language-text\">window.companyname</code> или <code class=\"language-text\">wingow.ga</code>.\nХорошей практикой будет дать возможность настраивать этот глобальный объект (noConflict), <a href=\"https://api.jquery.com/jquery.noconflict/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">как это делает jquery</a> (<em>не навреди</em>).\nВаш глобальный объект не должен показывать наружу внутренности. Используйте замыкания, чтобы хранить ваши данные.</p>\n<p>Каким должен быть глобальный объект? Варианты зависят от структуры вашего API.</p>\n<h3 id=\"массив\"><a href=\"#%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2\" aria-label=\"массив permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Массив</h3>\n<p>Такой глобальный объект представляет собой массив, а вызов API выглядит как добавление нового элемента через метод <code class=\"language-text\">push</code>. Основным плюсом является то, что код сайта может использовать такой объект до того, как библиотека загрузилась: при загрузке библиотека достаёт элементы и делает вызовы к API. После чего подменяет метод <code class=\"language-text\">push</code> глобального объекта. Такой подход использует Google Analytics старой версии (до universal) и Google Tag Manager.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Код сайта</span>\n<span class=\"token keyword\">var</span> _gaq <span class=\"token operator\">=</span> _gaq <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n_gaq<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'_setAccount'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UA-XXXXX-X'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n_gaq<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'_trackPageview'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> ga <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ga<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'text/javascript'</span><span class=\"token punctuation\">;</span> ga<span class=\"token punctuation\">.</span><span class=\"token keyword\">async</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  ga<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'https:'</span> <span class=\"token operator\">==</span> document<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">?</span> <span class=\"token string\">'https://ssl'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'http://www'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.google-analytics.com/ga.js'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> s<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>ga<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Обратите внимание, что переменная по умолчанию инициализируется пустым массивом. Это позволяет унифицировать запросы к\nAPI и не думать о том, загружена библиотека или нет.</p>\n<h3 id=\"функция\"><a href=\"#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F\" aria-label=\"функция permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Функция</h3>\n<p>Такой подход использует Google Analytics (скрипт analytics.js). Плюсом является очевидный и понятный API — вызов функции.\nОднако нужно позаботиться о том, что переменная доступна до загрузки скрипта. Это можно сделать\nпредоставив партнёрам готовый сниппет для вставки на сайт. Внутри сниппет должен создавать глобальную переменную\nи сохранять значения вызовов до того момента как библиотека будет загружена.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span>s<span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">,</span>g<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">[</span><span class=\"token string\">'GoogleAnalyticsObject'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>r<span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">||</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>l<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">*</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>a<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nm<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">.</span><span class=\"token keyword\">async</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">.</span>src<span class=\"token operator\">=</span>g<span class=\"token punctuation\">;</span>m<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span>document<span class=\"token punctuation\">,</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'https://www.google-analytics.com/analytics.js'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ga'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'create'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UA-XXXXX-Y'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'auto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'send'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pageview'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>В этом варианте библиотека складывает вызовы в массив.</em></p>\n<h3 id=\"объект\"><a href=\"#%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82\" aria-label=\"объект permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Объект</h3>\n<p>Может быть удобен в случае большого числа методов или иерархии методов. Примеры: jquery, moment, lodash.\nИспользуйте <a href=\"https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Object.freeze()</a>,\nчтобы исключить изменения вашего объекта внешним кодом (<em>работай правильно</em>).</p>\n<h2 id=\"никому-нельзя-доверять\"><a href=\"#%D0%BD%D0%B8%D0%BA%D0%BE%D0%BC%D1%83-%D0%BD%D0%B5%D0%BB%D1%8C%D0%B7%D1%8F-%D0%B4%D0%BE%D0%B2%D0%B5%D1%80%D1%8F%D1%82%D1%8C\" aria-label=\"никому нельзя доверять permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Никому нельзя доверять</h2>\n<p>Сайты до сих пор используют полифилы. Зачастую эти полифилы работают неправильно.\nВы можете наткнуться на кривую реализацию <code class=\"language-text\">window.Promise</code>.\nКак-то я столкнулся со старой версией prototype.js, которая заменяла добавляла полифил в массивы, который ломал JSON.stringify.\nИли недавно столкнулся с тем, что метод <code class=\"language-text\">map</code> массива возвращал не совсем массив.\nПоэтому все необходимые зависимости нужно тащить с собой (<em>работай правильно</em>).\nОднако тут нужно держать баланс (<em>тайминг важен</em>). Например, притащить внутренний полифил Promise неплохая идея, если вы поддерживаете IE.\nВ случае с prototype оказалось проще убедить клиента обновить версию, чем подключать свой сериализатор.\nХорошим инструментом для упаковки полифилов является webpack и плагин <strong>ProvidePlugin</strong>.\nЕго настройка проста и понятна:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>ProvidePlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  Promise<span class=\"token punctuation\">:</span> <span class=\"token string\">'promise-package-polyfill'</span><span class=\"token punctuation\">,</span>\n  fetch<span class=\"token punctuation\">:</span> <span class=\"token string\">'fetch-package-polyfill'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Как результат все <code class=\"language-text\">window.Promise</code> <strong>в вашем</strong> коде будут заменены на полифил.\nДумаю не надо объяснять, что основываться на наличии jquery на сайте не стоит 😁.</p>\n<h2 id=\"сторонние-зависимости\"><a href=\"#%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8\" aria-label=\"сторонние зависимости permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Сторонние зависимости</h2>\n<p>Старайтесь избегать сторонних библиотек когда это возможно. Это уменьшит размер бандла.\nНапример, если вам нужны методы из lodash, просто вытащите необходимые в отдельный файл.\nВ конечном бандле должен быть только используемый код.</p>\n<h2 id=\"обратная-совместимость-работай-правильно-не-навреди\"><a href=\"#%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F-%D1%81%D0%BE%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B9-%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE-%D0%BD%D0%B5-%D0%BD%D0%B0%D0%B2%D1%80%D0%B5%D0%B4%D0%B8\" aria-label=\"обратная совместимость работай правильно не навреди permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Обратная совместимость (работай правильно, не навреди)</h2>\n<p>Если ваш скрипт предоставляет какой-либо API, то он там навечно.\nНельзя пойти ко всем кто использует ваш скрипт и попросить изменить код или обновить версию.\nВыпуск новой несовместимой версии приведёт лишь к тому, что у вас будет две версии на поддержку (привет python!).\nЕсли вам нужно кардинально новое поведение метода API, пусть это будет новый метод.\nМогу посоветовать <a href=\"https://www.youtube.com/watch?v=oyLBGkS5ICk\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">отличный доклад Рика Хикки о зависимостях</a>.</p>\n<h2 id=\"запросы-к-серверу\"><a href=\"#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B-%D0%BA-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%83\" aria-label=\"запросы к серверу permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Запросы к серверу</h2>\n<p>Есть три основных способа взаимодействия вашей библиотеки с вашим сервером.</p>\n<h3 id=\"cors\"><a href=\"#cors\" aria-label=\"cors permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CORS</h3>\n<p>Поддерживается во всех браузерах (IE>=8). Хорош тем, что по сути это единственный нормальный API браузера для запроса к стороннему серверу.\nВы можете использовать как XMLHttpRequest так и fetch.\nДьявол кроется в деталях: любые непростые запросы будут генерировать дополнительный <strong>OPTIONS</strong> запрос.\nПростыми запросами считаются запросы, которые используют методы <strong>GET</strong>, <strong>POST</strong> или <strong>HEAD</strong> и содержат только заголовки из списка:</p>\n<ul>\n<li>Accept</li>\n<li>Accept-Language</li>\n<li>Content-Language</li>\n<li>Content-Type со значением <code class=\"language-text\">application/x-www-form-urlencoded</code>, <code class=\"language-text\">multipart/form-data</code> или <code class=\"language-text\">text/plain</code></li>\n</ul>\n<p>Обратите внимание: никаких Cookies. А значит при попытке передать куки будут делаться <strong>OPTIONS</strong> запросы.\nЧем плохи дополнительные запросы? <a href=\"https://blog.algolia.com/jsonp-still-mandatory/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Некоторые прокси их блокируют</a>.\nВ итоге ваша библиотека может перестать отправлять запросы на сервер (работай правильно).</p>\n<h3 id=\"iframe\"><a href=\"#iframe\" aria-label=\"iframe permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Iframe</h3>\n<p>Интересным вариантом является создание скрытого iframe, в котором вы открываете страницу на своём домене.\nС этим фреймом можно общаться через postMessage, а он в свою очередь будет делать запросы к серверу.\nТак как домен фрейма и сервера совпадают, то проблемы с CORS нет. Бонусом вы получаете localStorage,\nкоторый работает кроссдоменно.\nДелая такой механизм не забывайте об опасностях XSS атак.\nОсновным минусом такого подхода является дополнительная загрузка фрейма (тайминг важен).\nК тому же сафари блокирует куки и localStorage внутри фреймов.</p>\n<h3 id=\"jsonp\"><a href=\"#jsonp\" aria-label=\"jsonp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JSONP</h3>\n<p>Самый простой и везде работающий вариант. Если размещаете кэлбеки на <code class=\"language-text\">window</code>, а не на своём объекте,\nто не забывайте давать им достаточно сложные (рандомные имена).\nМинусом подхода является сложность кеширования запросов.</p>\n<h2 id=\"трекинг-пользователя\"><a href=\"#%D1%82%D1%80%D0%B5%D0%BA%D0%B8%D0%BD%D0%B3-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F\" aria-label=\"трекинг пользователя permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Трекинг пользователя</h2>\n<p>Вам скорее всего захочется понимать, что два запроса сделаны одним пользователем.\nСписок способов очень зависит от того насколько чувствительной является идентификатор.\nСтандартный способ – это использование куки. Однако в случае jsonp и CORS мы попадаем под правило third-party cookies.\nЭто значит, что большинство браузеров по умолчанию не будет отсылать куки на ваш домен,\nесли пользователь никогда его не посещал. Iframe лишен этого недостатка, куки будут отсылаться.\nНо это не будет работать в safari.\nЕсли перехват идентификатора третьими лицами не ведёт к каким либо чувствительным последствиям,\nто можно передавать идентификатор при каждом запросе и хранить его в куке сайта.\nЛучший вариант — комбинировать оба способа.</p>\n<h2 id=\"тестирование\"><a href=\"#%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5\" aria-label=\"тестирование permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Тестирование</h2>\n<p>Покрытие юнитами зависит от вашего желания. Для меня это хороший способ проверить сложную бизнес логику,\nно стопроцентное покрытие я считаю излишним.\nОчень хорошо работают интеграционные тесты, при которых тестируется код всей библиотеки,\nно стоят моки на запросы к серверу и сложные браузерные API. Для упрощения тестирования\nсуществующего кода, я сделал <a href=\"https://github.com/slonoed/startup\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">IoC обёртку</a>.\nИдеальным вариантом являются функциональные тесты прямо на сайтах, где используется библиотка.\nНо это чревато ложными срабатываниями.</p>\n<h2 id=\"кеширование\"><a href=\"#%D0%BA%D0%B5%D1%88%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5\" aria-label=\"кеширование permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Кеширование</h2>\n<p>Если ваша библиотека подразумевает инкрементальные апдейты, то вам необходим механизм позволяющий\nобновлять её по необходимости, не меняя кода сайтов, где библиотека установлена.\nИ при этом необходимо иметь кеширование для уменьшение нагрузки на сервера и ускорения\nповторной загрузки кода (тайминг важен).</p>\n<p>Есть два основных подхода</p>\n<h3 id=\"загрузчик\"><a href=\"#%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D1%87%D0%B8%D0%BA\" aria-label=\"загрузчик permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Загрузчик</h3>\n<p>Скрипт, который подключается на сайте является <strong>некешируемым</strong> файлом. Единственное его назначение —\nдобавить тег script со ссылкой на основной бандл. В ссылке есть хеш бандла, а сам бандл имеет максимальное\nвремя кеша. Такой подход позволяет быстро деплоиться и при этом иметь большой кеш.\nМинус очевидный — при первом заходе и после выкатки придётся грузить два скрипта (тайминг важен).</p>\n<h3 id=\"небольшой-кеш-бандла\"><a href=\"#%D0%BD%D0%B5%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%BE%D0%B9-%D0%BA%D0%B5%D1%88-%D0%B1%D0%B0%D0%BD%D0%B4%D0%BB%D0%B0\" aria-label=\"небольшой кеш бандла permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Небольшой кеш бандла</h3>\n<p>Если первая загрузка очень важна, а сессии пользователя короткие, то вариант с одним файлом и небольшим кешем может оказаться лучше.\nТут важно посчитать выгоду от быстрой первой загрузки и потерю на стоимости трафика.\nУдобно иметь отдельную настройку, которой можно менять кеш файла.\nТогда перед деплоем можно сбросить кеш в 0, подождать инвалидации у всех пользователей и накатывать апдейт.\nА после увеличить время кеша.</p>\n<h2 id=\"ошибки-и-логирование\"><a href=\"#%D0%BE%D1%88%D0%B8%D0%B1%D0%BA%D0%B8-%D0%B8-%D0%BB%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5\" aria-label=\"ошибки и логирование permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ошибки и логирование</h2>\n<p>Ваше приложение будет исполнятся на других сайтах, в неизвестных условиях и неизвестных браузерах.\nПериодически будут <strong>возникать ошибки</strong>.  Ошибки могут быть совершенно любые.\nОшибки, которые вы не перехватили, будут <strong>падать в контекст сайта</strong> и отправляться в систему логирования ваших клиентов.\nПоэтому, везде, где есть возможность исключения должен быть try/catch. Везде, где есть промис, должен быть catch.</p>\n<p>Хорошей идеей будет вешаться на глобальные ошибки и по стеку определять приходят ли они из библиотеки.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unhandledrejection'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOurError</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// log</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOurError</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// log</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Сами логи стоит разделить по уровню и дать возможность в продакшене менять уровень.\nЭто позволит тестерам вылавливать предупреждения.\nЯ использовал <a href=\"https://gist.github.com/slonoed/32b40f5d5af2de0e889c169e436d2b80\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">вот такой простой логер</a>.</p>\n<p>Все критические ошибки необходимо отправлять на сервер для последующего анализа.\nПомимо текста ошибки и стека стоит отправлять информацию касающуюся браузера\n(user agent, разрешение экрана, прочее) и стейт самой библиотеки (версия, вызванные методы API и так далее).\nЭто сильно упростит поиск плавающих ошибок.\nДля хранения большого количества ошибок на сервере неплохо подходит эластик.</p>\n<h2 id=\"поддержка-браузеров\"><a href=\"#%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B0-%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D0%BE%D0%B2\" aria-label=\"поддержка браузеров permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Поддержка браузеров</h2>\n<p>Поддержка того или иного браузера всегда зависит от количества денег, которое можно\nполучить с пользователей этого браузера и затратами на поддержку.\nНо есть нюансы: могут быть браузеры, которые ломают ваш код самым неприятным образом\n(привет Яндекс Браузер!) и узнаете вы об этом только после того, как к вам придут злые клиенты, которых\nпользователи пинали в саппорте.\nИ поэтому может быть полезна модель белого списка: набор браузеров, где библиотека будет\nзапускаться. Для всех остальных она будет выключена или выполнять минимум функций.\nПри этом важно собирать статистику всех браузеров, чтобы понять когда стоит добавить поддержку.\nНе забывайте следить за новыми версиями. Желательно проверять всё ещё в бета-версиях.</p>","timeToRead":12,"frontmatter":{"title":"Разработка сторонних библиотек","date":"May 22, 2017","description":"Разработка и поддержка сторонних библиотек. Основные принципы, методики и ошибки."},"fields":{"slug":"/ru/third-party-js/","langKey":"ru"}},"altPost":{"id":"5b4d6142-fce3-52fc-a50a-45bede9f75d2","fields":{"slug":"/third-party-js/","langKey":"en"}}},"pageContext":{"slug":"/ru/third-party-js/","altSlug":"/third-party-js/"}}