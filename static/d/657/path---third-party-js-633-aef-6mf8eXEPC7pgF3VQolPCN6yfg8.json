{"data":{"site":{"siteMetadata":{"title":"slonoed","author":"Dmitry Manannikov","siteUrl":"https://slonoed.net"}},"markdownRemark":{"id":"5b4d6142-fce3-52fc-a50a-45bede9f75d2","html":"<p>Quite a lot of products use third-party libraries.\nA good example is the Google Analytics scripts.\nSuch libraries are loaded from a separate domain and provide API to the final product.\nI was engaged in supporting and improving such a library in Flocktory company.\nI will tell you about the peculiarities of developing such a library, and I will show good practices and tell you how to get around the basic mistakes. This note is structured from the bottom up. Therefore, first I will touch on the issues of writing code, and by the end, I will tell you about common things.</p>\n<h2 id=\"principles\"><a href=\"#principles\" aria-label=\"principles permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Principles</h2>\n<p>For the structuring and application of information, it is convenient to agree on the principles for the development of such products. I propose four basic principles in order of decreasing importance.</p>\n<ol>\n<li>Do not harm (Safety)</li>\n<li>Work correctly (Correctness)</li>\n<li>Timing is critical (Time optimization)</li>\n<li>Performance is critical</li>\n</ol>\n<p><em>Actually, items 3 and 4 can change places. It all depends on the purpose of the product and the sites where it is used.</em></p>\n<p>Let’s consider each of them separately.</p>\n<h3 id=\"do-no-harm\"><a href=\"#do-no-harm\" aria-label=\"do no harm permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do no harm</h3>\n<p>The library code is executed on a third-party site. New customers appear every day.\nBreaking the code of any of the sites can lead to huge reputational and monetary losses.</p>\n<h3 id=\"work-correctly\"><a href=\"#work-correctly\" aria-label=\"work correctly permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Work correctly</h3>\n<p>For business, it is vital that this code works correctly. Agree, no one will use Google Analytical if an analytics data are not correct.</p>\n<h3 id=\"timing-is-critical\"><a href=\"#timing-is-critical\" aria-label=\"timing is critical permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Timing is critical</h3>\n<p>For such libraries, download and start speed are important. An Early start allows not to miss the first user actions.</p>\n<h3 id=\"performance-is-critical\"><a href=\"#performance-is-critical\" aria-label=\"performance is critical permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance is critical</h3>\n<p>No one will tolerate a code that slows down and worsens the user experience.</p>\n<h2 id=\"global-object\"><a href=\"#global-object\" aria-label=\"global object permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Global Object</h2>\n<p>In an ideal version, your code should be wrapped in a closure without any way of being called from the outside.\nIn case you need to give an API, the best you can afford is one global object that does not cause collisions,\nfor example, <code class=\"language-text\">window.companyname</code> or <code class=\"language-text\">wingow.ga</code>.\nIt is a good practice to enable this global object (noConflict), <a href=\"https://api.jquery.com/jquery.noconflict/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">as jquery does</a> (<em>do no harm</em>).\nYour global object should not show the inside. Use closures to store your data.</p>\n<p>What should be a global object? The options depend on the structure of your API.</p>\n<h3 id=\"array\"><a href=\"#array\" aria-label=\"array permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Array</h3>\n<p>This global object is an array, and the API call looks like adding a new element via the <code class=\"language-text\">push</code> method. The main advantage is that the site code can use such an object before the library is loaded: when loading the library, it takes out the elements and makes calls to the API. Then it replaces the <code class=\"language-text\">push</code> method of the global object. This approach is used by Google Analytics from the old version (to universal) and Google Tag Manager.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> _gaq <span class=\"token operator\">=</span> _gaq <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n_gaq<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'_setAccount'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UA-XXXXX-X'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n_gaq<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'_trackPageview'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> ga <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ga<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'text/javascript'</span><span class=\"token punctuation\">;</span> ga<span class=\"token punctuation\">.</span><span class=\"token keyword\">async</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  ga<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'https:'</span> <span class=\"token operator\">==</span> document<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">?</span> <span class=\"token string\">'https://ssl'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'http://www'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.google-analytics.com/ga.js'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> s<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>ga<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Note that the default variable is initialized with an empty array. This allows you to unify the queries to API and do not think about whether the library is loaded or not.</p>\n<h3 id=\"function\"><a href=\"#function\" aria-label=\"function permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Function</h3>\n<p>This approach is used by Google Analytics (script analytics.js). Pros is an obvious and understandable API - function call.\nHowever, you need to make sure that the variable is available before the script is loaded. It can be done providing partners with a ready-made snippet for insertion on the site. Inside, the snippet must create a global variable and store the call arguments ​​until the library is loaded.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span>s<span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">,</span>g<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">[</span><span class=\"token string\">'GoogleAnalyticsObject'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>r<span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">||</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>l<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">*</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>a<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nm<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">.</span><span class=\"token keyword\">async</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">.</span>src<span class=\"token operator\">=</span>g<span class=\"token punctuation\">;</span>m<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span>document<span class=\"token punctuation\">,</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'https://www.google-analytics.com/analytics.js'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ga'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'create'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'UA-XXXXX-Y'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'auto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'send'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pageview'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>In this version, the library adds calls to the array.</em></p>\n<h3 id=\"an-object\"><a href=\"#an-object\" aria-label=\"an object permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An object</h3>\n<p>It can be useful in the case of a large number of methods or a hierarchy of methods. Examples: jquery, moment, lodash.\nUse <a href=\"https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Object.freeze()</a>,\nTo exclude changes to your object by external code (<em>work correctly</em>).</p>\n<h2 id=\"trust-no-one\"><a href=\"#trust-no-one\" aria-label=\"trust no one permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Trust no one</h2>\n<p>Sites still use polyfill. Often these polyfills do not work properly.\nYou can stumble upon a broken implementation of <code class=\"language-text\">window.Promise</code>.\nOnce I found the old version prototype.js which replaced added polyfill in arrays which broke JSON.stringify.\nOr you can run into the fact that the <code class=\"language-text\">map</code> method of the array returned not exactly an array.\nTherefore, all necessary dependencies need to be packed along (<em>work correctly</em>).\nHowever, you need to keep a balance (<em>timing is important</em>). For example, dragging an internal  Promise polyfill is a good idea if you support IE.\nIn the case of prototype.js, it was easier to convince the client to update the version, than to bring own serializer.\nAn excellent tool for packaging polyfills is the webpack and the  <strong>ProvidePlugin</strong>.\nIts setting is simple and straightforward:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">New <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>ProvidePlugin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  Promise<span class=\"token punctuation\">:</span> <span class=\"token string\">'promise-package-polyfill'</span><span class=\"token punctuation\">,</span>\n  Fetch<span class=\"token punctuation\">:</span> <span class=\"token string\">'fetch-package-polyfill'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>As a result, all <code class=\"language-text\">window.Promise</code> <strong>in your</strong> code will be replaced with polyfills.\nOf course assuming jquery on sites is a bad idea😁.</p>\n<h2 id=\"dependencies\"><a href=\"#dependencies\" aria-label=\"dependencies permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependencies</h2>\n<p>Try to avoid third-party libraries whenever possible. This reduces the size of the bundle.\nFor example, if you need methods from the lodash, simply extract the necessary ones into a separate file.\nOnly real used code should be in the bundle.</p>\n<h2 id=\"backward-compatibility-work-correctly-do-no-harm\"><a href=\"#backward-compatibility-work-correctly-do-no-harm\" aria-label=\"backward compatibility work correctly do no harm permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Backward compatibility (work correctly, do no harm)</h2>\n<p>If your script provides any API, then it is there forever.\nYou can not go to all who use your script and ask to change the code or update the version.\nThe release of a new incompatible version only leads to the fact that you will have two versions for support (hello python!).\nIf you need a coordinate new behavior of the API method, consider creating a new method.\nI can advise <a href=\"https://www.youtube.com/watch?v=oyLBGkS5ICk\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Rick Hickey’s excellent report on addictions</a>.</p>\n<h2 id=\"server-requests\"><a href=\"#server-requests\" aria-label=\"server requests permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Server requests</h2>\n<p>There are three main ways your library interacts with your server.</p>\n<h3 id=\"cors\"><a href=\"#cors\" aria-label=\"cors permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CORS</h3>\n<p>Supported in all browsers (IE> = 8). CORS is the only standard browser API for querying a third-party server.\nYou can use both <code class=\"language-text\">XMLHttpRequest</code> and <code class=\"language-text\">fetch</code>.\nThe devil is in the details: any non-simple queries generate an additional <strong>OPTIONS</strong> request.\nSimple queries are considered to be queries that use the methods <strong>GET</strong>, <strong>POST</strong> or <strong>HEAD</strong> and contain only the headers from the list:</p>\n<ul>\n<li>Accept</li>\n<li>Accept-Language</li>\n<li>Content-Language</li>\n<li>Content-Type with the value of <code class=\"language-text\">application/x-www-form-urlencoded</code>, <code class=\"language-text\">multipart/form-data</code> or <code class=\"language-text\">text/plain</code></li>\n</ul>\n<p>Please note no cookies. So when you try to transfer cookies <strong>OPTIONS</strong> request appears.\nWhy <strong>OPTIONS</strong> requests is an issue? <a href=\"https://blog.algolia.com/jsonp-still-mandatory/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Some proxy blocks them</a>.\nAs a result, your library may stop sending requests to the server (<em>work correctly</em>).</p>\n<h3 id=\"iframe\"><a href=\"#iframe\" aria-label=\"iframe permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Iframe</h3>\n<p>An interesting option is to create a hidden iframe, in which you open a page on your domain.\nWith this frame, you can communicate through <code class=\"language-text\">postMessage</code>, and make requests to the server from iframe.\nSince the domain of the frame and the server are the same, there is no problem with CORS. Bonus you get crossdomain <code class=\"language-text\">localStorage</code>,\nDoing such a mechanism, do not forget about the dangers of XSS attacks.\nThe main disadvantage of this approach is the additional frame loading (<em>timing is critical</em>).\nAlso, Safari blocks cookies and localStorage within frames.</p>\n<h3 id=\"jsonp\"><a href=\"#jsonp\" aria-label=\"jsonp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JSONP</h3>\n<p>The simplest option and it works everywhere. If you place the callbacks on <code class=\"language-text\">window</code>,\nand not on your object, then do not forget to give them quite complex random names.\nThe downside of the approach is the complexity of query caching.</p>\n<h2 id=\"user-tracking\"><a href=\"#user-tracking\" aria-label=\"user tracking permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>User tracking</h2>\n<p>You most likely want to understand that two requests are made by one user.\nThe list of ways depends very much on how sensitive the identifier is.\nThe standard way is to use cookies. However, in the case of JSONP and CORS, we fall under the rule of third-party cookies.\nThis means that most browsers will not by default send cookies to your domain if the user has never visited it.\nIframe don’t have this issue, the cookies will be sent.\nBut this will not work in safari.\nIf the interception of the identifier by third parties does not lead to any sensitive consequences,\nThen you can pass the identifier for each request and store it in the site cookie.\nThe best option is to combine both methods.</p>\n<h2 id=\"testing\"><a href=\"#testing\" aria-label=\"testing permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing</h2>\n<p>Code coverage with units depends on your desire. For me, this is a good way to test complex business logic.\nI do not think 100% is the main target.\nIntegration tests work very well at which the entire library code is tested with some mocks\nfor requests to the server and complex browser APIs. To simplify testing of the existing code, I made <a href=\"https://github.com/slonoed/startup\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">IoC wrapper</a>.\nIdeal options are functional tests right on the sites where the library is used.\nHowever, this can raise false positives.</p>\n<h2 id=\"caching\"><a href=\"#caching\" aria-label=\"caching permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Caching</h2>\n<p>If your library implies incremental updates, then you need a mechanism that allows update it as necessary,\nwithout changing the code of sites where the library is installed.\nAlso, at the same time, it is necessary to have caching to reduce server load and downloads speed up (<strong>timing is critical</strong>).</p>\n<p>There are two main approaches</p>\n<h3 id=\"loader\"><a href=\"#loader\" aria-label=\"loader permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Loader</h3>\n<p>Site require only small <strong>noncached</strong> file. It is only purposed to add a script tag with a link to the main bundle.\nIn the link, there is a hash of the bundle, and the bandle has the maximum\ncache time. This approach allows you to quickly deploy and at the same time have a large cache.\nThe cons are obvious - at the first visit and after deploy browser loads two scripts (timing is critical).</p>\n<h3 id=\"a-small-bundle-cache\"><a href=\"#a-small-bundle-cache\" aria-label=\"a small bundle cache permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A small bundle cache</h3>\n<p>If the first boot is vital and the user sessions are short, then the option with one file and a small cache can be better.\nIt is important to calculate the benefit of a quick first boot and a loss in the cost of traffic.\nNice to have a separate setting, which you can change the cache of the file.\nThen before the release, it is possible to reset the cache to zero, wait for cache invalidation from all users and roll up the update. Later you can increase cache again.</p>\n<h2 id=\"errors-and-logging\"><a href=\"#errors-and-logging\" aria-label=\"errors and logging permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Errors and Logging</h2>\n<p>Your library will be executed on other sites, in unknown conditions and unknown browsers.\nPeriodically <strong>there will be</strong> errors. Errors can be completely arbitrary.\nErrors that you did not intercept will <strong>fall into the context of the site</strong> and be sent to the logging system of your clients.\nTherefore, any code with possible exception should be in <code class=\"language-text\">try/catch</code>. Wherever there is a <code class=\"language-text\">Promise.then</code>, there must be <code class=\"language-text\">catch</code>.</p>\n<p>A good idea will be to hang on to global errors and determine whether they come from the library on the stack.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'unhandledrejection'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">If</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOurError</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// log</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nWindow<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">If</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isOurError</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// log</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Logs should be divided by level and give the opportunity to change the level in a production.\nThis allows testers to catch warnings in a testing phase.\nI use <a href=\"https://gist.github.com/slonoed/32b40f5d5af2de0e889c169e436d2b80\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">such a simple logger</a>.</p>\n<p>All critical errors must be sent to the server for further analysis.\nIn addition to the text of the error and the stack,\nit is worth sending information about the browser (userUagent, screen resolution, etc.)\nand the state of the library itself (version, API methods called, and so on).\nThis greatly simplifies the search for floating errors.\nTo store a significant number of errors on the server you can use elastic</p>\n<h2 id=\"browser-support\"><a href=\"#browser-support\" aria-label=\"browser support permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Browser Support</h2>\n<p>The support of a particular browser always depends on the amount of money that can be get from users of this browser and the costs of support.\nHowever, there are nuances: there can be browsers that break your code in the most unpleasant way.\nAnd you will find out about this only after you get angry clients whom users kicked in the support.\nSo the whitelist model can be useful: a set of browsers, where the library runs.\nFor all others, it will be turned off or perform a minimum of functions.\nIt is important to collect statistics of all browsers to understand when to add support.\nDo not forget to check the new versions.</p>","timeToRead":10,"frontmatter":{"title":"Third party libraries","date":"May 22, 2017","description":"Third party library development best practices."},"fields":{"slug":"/third-party-js/","langKey":"en"}}},"pageContext":{"slug":"/third-party-js/"}}